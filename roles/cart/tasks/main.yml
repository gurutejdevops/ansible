- name: Ensure CentOS vault base repo is in place
  ansible.builtin.copy:
    src: CentOS-Base.repo
    dest: /etc/yum.repos.d/CentOS-Base.repo
    backup: yes

- name: Add NodeSource 16.x repo (Ansible-native, one-time)
  ansible.builtin.yum_repository:
    name: nodesource
    description: Node.js 16.x
    baseurl: https://rpm.nodesource.com/pub_16.x/el/7/$basearch
    gpgcheck: yes
    gpgkey: https://rpm.nodesource.com/pub/el/NODESOURCE-GPG-SIGNING-KEY-EL
    enabled: yes

- name: Install Node.js (npm included)
  ansible.builtin.yum:
    name: nodejs
    state: present
    update_cache: yes

- name: Create application user
  ansible.builtin.user:
    name: "{{ APPUSER | default('roboshop') }}"
    state: present
    shell: /bin/bash
    create_home: yes

- name: Create app directory
  ansible.builtin.file:
    path: /home/{{ APPUSER | default('roboshop') }}/cart
    state: directory
    owner: "{{ APPUSER | default('roboshop') }}"
    group: "{{ APPUSER | default('roboshop') }}"

# Fetch and unpack directly into the app dir; only once unless source changes
- name: Download cart service zip
  ansible.builtin.get_url:
    url: https://github.com/stans-robot-project/cart/archive/refs/heads/main.zip
    dest: /tmp/cart-main.zip
  register: cart_zip

- name: Unarchive into app dir (strip top folder)
  ansible.builtin.unarchive:
    src: /tmp/cart-main.zip
    dest: /tmp/
    remote_src: yes

- name: cleanup
  ansible.builtin.file:
    path: /home/roboshop/user/
    state: absent
  ignore_errors: yes
  when: cart_zip.changed

- name: copying
  ansible.builtin.copy:
    src: /tmp/user-main/
    dest: /home/roboshop/user/
    remote_src: yes
  when: cart_zip.changed
  notify: npm install
  
# Systemd unit from template (idempotent)
- name: Deploy cart systemd unit
  ansible.builtin.template:
    src: systemd.service
    dest: /etc/systemd/system/cart.service
  notify:
    - daemon-reload
    - restart cart

# Ensure service is enabled/started (no unnecessary restarts)
- name: Enable & start cart
  ansible.builtin.service:
    name: cart
    state: started
    enabled: yes
